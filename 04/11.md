### ✍️ Tangxt ⏳ 2020-09-17 🏷️ Vuex

# 11-Vue 全局数据管理（上）

## ★前言

上节课遗留的问题：改了这个页面的数据，另一个页面没有同步更新这个数据 （**各自为政**）-> 解决办法 -> 全局数据管理！

方方的一个观点（人的主观想法，不一定对）：

![全局数据管理](assets/img/2020-09-21-18-36-57.png)

前端把这个全局数据管理搞得超级复杂，而目前还咩有把这个东西回归到最朴素的状态！ -> 为啥咩有回归？ -> 因为前端还咩有搞清楚全局数据管理到底是什么！

➹：[在 2016 年学 JavaScript 是一种什么样的体验？ - 知乎](https://zhuanlan.zhihu.com/p/22782487)

## ★再次封装 recordListModel

1）提取 data

任何操作表的 `data` 都交给`recordListModel`来做 -> 之后的统计页面拿数据也方便！

代码：[Demo](https://github.com/ppambler/vue-morney/commit/407511195faeecbb015677ba9df18c79272a47e2)

2）封装 create

> 叫`createItem`比较好听！ 

代码：[Demo](https://github.com/ppambler/vue-morney/commit/dc88c79e7bbf283201da0dafd46c2c6d613a06f5)

💡：第一次使用`any`类型？

把经常用的`clone`方法封装到`lib`里边的`clone.ts`

![any 类型](assets/img/2020-09-21-19-34-54.png)

其它模块文件使用这个`clone`方法，直接`import`一下就好了！

3）小结

把获取数据，新增数据，保存数据的操作都封装到`recordListModel`里边去了！

接下来做一下全局数据管理 -> 解决页面之间数据不同步的问题！

## ★用 window 来容纳数据

1）页面之间数据不同步的原因

![数据同步](assets/img/2020-09-23-14-28-38.png)

我的已知认识是这样的：

`Money.vue`里边导入了`tagListModel`，`Labels.vue`里边也导入了`tagListModel` -> 这两个`tagListModel`是同一个地址！

我的测试：

把这两个`tagListModel`各自扔到`window`上，看看它们是否全等？

经过测试，它们确实是全等的！

![tagListModel](assets/img/2020-09-23-15-08-47.png)

既然如此，那么问题来了，我们在标签页创建了一个标签，就会往`tagListModel`里边追加了一个标签，可记账页却没有同步更新？ -> 所以，这是怎么一回事呢？

我猜测这是 Vue 不能检测数组项修改的原因！

我们知道 `tagListModel.data`的数据结构是这样的 `[{},{}]`，我们在创建标签的时候用了 `tagListModel.data.push({ id, name: name })`，而这个`push`显然不是 Vue 更改过的 `push` 方法！所以这就导致了数据不同步更新的问题！

我用了`Vue.set()`测试一下，结果还是如此：

![Vue set 也不行](assets/img/2020-09-23-15-41-50.png)

---

按照老师的解释 -> 我们代码是在把同一个 JSON 字符串分别做成了对象 1 和对象 2 -> 解决姿势是 -> 弄成是同一个对象！

![这两个data是不同的](assets/img/2020-09-23-15-49-37.png)

---

测试：

![测试](assets/img/2020-09-23-15-58-15.png)

![两次fetch](assets/img/2020-09-23-16-13-25.png)

再次测试在不同模块里边导入相同的模块：

![测试](assets/img/2020-09-23-16-08-45.png)

我在`tagListModel.ts`里边，写了行 `console.log(1)`，然后再不同文件模块里边各写一次`import tagListModel from "@/models/tagListModel";`，结果只`log`一次`1`！

2）解决 bug

思路：

![思路](assets/img/2020-09-23-17-10-16.png)

在 `main.ts` 里边搞个全局变量 -> 往上提（`Money.vue` -> `App.vue` -> `main.ts`）

代码：[Demo](https://github.com/ppambler/vue-morney/commit/d6a71bc5a0d15719a2e4f827748c303649e9a853)

💡：你直接这样写：`window.tagList = tagListModel.fetch();`会报错？

为啥`tsc`会报错？ -> 因为`window`根本就咩有`tagList`属性，所以你不能这样做！

我们写 JS 可以随意加，但是`tsc`是不允许的！

所以，我们得声明一下这个`Window`

``` ts
// custom.d.ts
interface Window {
  tagList: Tag[];
}
```

为啥要这样做？有种脱裤子放屁的感觉……

其实这是为了约束你写代码，保证不会写出`taglsit`这样的无用属性，以及不会写出`'666'`这样的数据类型 -> 总之，你要记住，`tsc`就是在用类型检查你的代码写得有没有错！

💡：标签多了，创建标签`button`就看不见了？

![创建标签](assets/img/2020-09-23-17-12-49.png)










